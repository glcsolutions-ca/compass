name: Commit Stage

permissions:
  actions: read
  contents: read
  pull-requests: read
  id-token: write

env:
  EXPECTED_ENTRYPOINT: /

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

jobs:
  determine_scope:
    name: determine-scope
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      scope_path: ${{ steps.scope.outputs.scope_path }}
      base_sha: ${{ steps.scope.outputs.base_sha }}
      head_sha: ${{ steps.scope.outputs.head_sha }}
      tested_sha: ${{ steps.scope.outputs.tested_sha }}
      pr_number: ${{ steps.scope.outputs.pr_number }}
      change_class: ${{ steps.scope.outputs.change_class }}
      runtime_changed: ${{ steps.scope.outputs.runtime_changed }}
      desktop_changed: ${{ steps.scope.outputs.desktop_changed }}
      infra_changed: ${{ steps.scope.outputs.infra_changed }}
      identity_changed: ${{ steps.scope.outputs.identity_changed }}
      migration_changed: ${{ steps.scope.outputs.migration_changed }}
      infra_rollout_changed: ${{ steps.scope.outputs.infra_rollout_changed }}
      docs_only_changed: ${{ steps.scope.outputs.docs_only_changed }}
      delivery_config_changed: ${{ steps.scope.outputs.delivery_config_changed }}
      requires_infra_convergence: ${{ steps.scope.outputs.requires_infra_convergence }}
      requires_migrations: ${{ steps.scope.outputs.requires_migrations }}
      changed_files_json: ${{ steps.scope.outputs.changed_files_json }}
      required_flow_ids_json: ${{ steps.scope.outputs.required_flow_ids_json }}
      docs_drift_blocking: ${{ steps.scope.outputs.docs_drift_blocking }}
      docs_drift_path: ${{ steps.docs_drift.outputs.docs_drift_path }}
      docs_drift_status: ${{ steps.docs_drift.outputs.docs_drift_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Resolve commit scope
        id: scope
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          GITHUB_TESTED_SHA: ${{ github.sha }}
        run: node scripts/pipeline/commit/resolve-scope.mjs

      - name: Upload scope artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: commit-scope-${{ steps.scope.outputs.tested_sha }}
          path: ${{ steps.scope.outputs.scope_path }}
          if-no-files-found: warn

      - name: Evaluate docs drift
        id: docs_drift
        env:
          HEAD_SHA: ${{ steps.scope.outputs.head_sha }}
          TESTED_SHA: ${{ steps.scope.outputs.tested_sha }}
          CHANGED_FILES_JSON: ${{ steps.scope.outputs.changed_files_json }}
        run: node scripts/pipeline/commit/check-docs-drift.mjs

      - name: Upload docs-drift artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: docs-drift-${{ steps.scope.outputs.tested_sha }}
          path: .artifacts/docs-drift/${{ steps.scope.outputs.tested_sha }}/result.json
          if-no-files-found: warn

  fast_feedback:
    name: fast-feedback
    needs:
      - determine_scope
    if: ${{ github.event_name == 'pull_request' && (needs.determine_scope.outputs.runtime_changed == 'true' || needs.determine_scope.outputs.infra_changed == 'true' || needs.determine_scope.outputs.identity_changed == 'true' || needs.determine_scope.outputs.delivery_config_changed == 'true') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run fast feedback suite
        run: pnpm commit:fast-feedback

  desktop_fast_feedback:
    name: desktop-fast-feedback
    needs:
      - determine_scope
    if: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.desktop_changed == 'true' && needs.determine_scope.outputs.docs_only_changed != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run desktop fast feedback suite
        run: |
          pnpm --filter @compass/desktop lint
          pnpm --filter @compass/desktop test
          pnpm --filter @compass/desktop typecheck

  infra_static_check:
    name: infra-static-check
    needs:
      - determine_scope
    if: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.infra_changed == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile Bicep entrypoint
        run: az bicep build --file infra/azure/main.bicep --stdout >/dev/null

  identity_static_check:
    name: identity-static-check
    needs:
      - determine_scope
    if: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.identity_changed == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt check
        run: terraform -chdir=infra/identity fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=infra/identity init -backend=false -input=false

      - name: Terraform validate
        run: terraform -chdir=infra/identity validate

  commit_stage:
    name: commit-stage
    if: ${{ always() }}
    needs:
      - determine_scope
      - fast_feedback
      - desktop_fast_feedback
      - infra_static_check
      - identity_static_check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Collect commit-stage timing
        id: timing
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          HEAD_SHA: ${{ needs.determine_scope.outputs.head_sha }}
          TESTED_SHA: ${{ needs.determine_scope.outputs.tested_sha }}
          TIMING_PHASE: final
        run: node scripts/pipeline/shared/collect-commit-stage-timing.mjs

      - name: Decide commit stage
        env:
          HEAD_SHA: ${{ needs.determine_scope.outputs.head_sha }}
          TESTED_SHA: ${{ needs.determine_scope.outputs.tested_sha }}
          RUNTIME_REQUIRED: ${{ github.event_name == 'pull_request' && (needs.determine_scope.outputs.runtime_changed == 'true' || needs.determine_scope.outputs.infra_changed == 'true' || needs.determine_scope.outputs.identity_changed == 'true' || needs.determine_scope.outputs.delivery_config_changed == 'true') }}
          DESKTOP_REQUIRED: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.desktop_changed == 'true' && needs.determine_scope.outputs.docs_only_changed != 'true' }}
          INFRA_REQUIRED: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.infra_changed }}
          IDENTITY_REQUIRED: ${{ github.event_name == 'pull_request' && needs.determine_scope.outputs.identity_changed }}
          DOCS_DRIFT_BLOCKING: ${{ needs.determine_scope.outputs.docs_drift_blocking }}
          DOCS_DRIFT_STATUS: ${{ needs.determine_scope.outputs.docs_drift_status }}
          COMMIT_STAGE_SLO_MODE: ${{ steps.timing.outputs.commit_stage_slo_mode }}
          COMMIT_STAGE_SLO_PASS: ${{ steps.timing.outputs.commit_stage_slo_pass }}
          COMMIT_STAGE_SLO_TARGET_SECONDS: ${{ steps.timing.outputs.commit_stage_slo_target_seconds }}
          TIME_TO_COMMIT_GATE_SECONDS: ${{ steps.timing.outputs.time_to_commit_gate_seconds }}
          CHECK_RESULTS_JSON: ${{ format('{{"determine-scope":"{0}","fast-feedback":"{1}","desktop-fast-feedback":"{2}","infra-static-check":"{3}","identity-static-check":"{4}"}}', needs.determine_scope.result, needs.fast_feedback.result, needs.desktop_fast_feedback.result, needs.infra_static_check.result, needs.identity_static_check.result) }}
        run: node scripts/pipeline/commit/decide-commit-stage.mjs

      - name: Upload commit-stage artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: commit-stage-${{ needs.determine_scope.outputs.tested_sha }}
          path: |
            .artifacts/commit-stage/${{ needs.determine_scope.outputs.tested_sha }}/result.json
            .artifacts/commit-stage/${{ needs.determine_scope.outputs.tested_sha }}/timing.json
          if-no-files-found: warn
