name: Dependabot Auto Merge

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize

permissions:
  checks: read
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  enable_auto_merge:
    name: dependabot-auto-merge
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Classify safe lane
        id: safe_lane
        env:
          UPDATE_TYPES_RAW: ${{ steps.metadata.outputs.update-type }}
        run: |
          set -euo pipefail
          update_types="${UPDATE_TYPES_RAW// /}"

          if [ -z "$update_types" ]; then
            echo "safe=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IFS=',' read -r -a types <<< "$update_types"
          for update_type in "${types[@]}"; do
            case "$update_type" in
              version-update:semver-patch|version-update:semver-minor)
                ;;
              *)
                echo "safe=false" >> "$GITHUB_OUTPUT"
                exit 0
                ;;
            esac
          done

          echo "safe=true" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        id: gate_contexts
        if: ${{ steps.safe_lane.outputs.safe == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          checks_json="$(gh pr checks --repo "$REPOSITORY" "$PR_NUMBER" --json name,state)"
          has_commit_stage_gate="$(jq -r 'map(select(.name=="commit-stage-gate")) | length' <<<"$checks_json")"
          has_quick_feedback="$(jq -r 'map(select(.name=="quick-feedback")) | length' <<<"$checks_json")"

          if [ "$has_commit_stage_gate" -lt 1 ] || [ "$has_quick_feedback" -lt 1 ]; then
            echo "gate_contexts_ok=false" >> "$GITHUB_OUTPUT"
            echo "Required gate contexts are missing for PR #$PR_NUMBER. Auto-merge will not be enabled."
            echo "Found checks:"
            jq -r '.[].name' <<<"$checks_json"
            exit 0
          fi

          echo "gate_contexts_ok=true" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        if: ${{ steps.safe_lane.outputs.safe == 'true' && steps.gate_contexts.outputs.gate_contexts_ok == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          if gh pr merge --repo "$REPOSITORY" --auto --merge "$PR_NUMBER"; then
            echo "Auto-merge enabled for Dependabot safe-lane PR #$PR_NUMBER"
          else
            echo "Unable to enable auto-merge for PR #$PR_NUMBER; leaving PR open for manual action."
          fi
