name: Infra Apply

on:
  workflow_call:
    inputs:
      api_image_ref:
        description: Digest image ref for API app (repo@sha256:...)
        required: true
        type: string
      web_image_ref:
        description: Digest image ref for Web app (repo@sha256:...)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      image_tag:
        description: Optional image tag for API/Web rollback convenience
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  bicep_apply:
    name: infra-apply
    environment: production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HEAD_SHA: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_DEPLOY_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Preflight Azure context, region, vars, and providers
        env:
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_VNET_NAME: ${{ vars.AZURE_VNET_NAME }}
          AZURE_ACA_SUBNET_NAME: ${{ vars.AZURE_ACA_SUBNET_NAME }}
          AZURE_POSTGRES_SUBNET_NAME: ${{ vars.AZURE_POSTGRES_SUBNET_NAME }}
          AZURE_PRIVATE_DNS_ZONE_NAME: ${{ vars.AZURE_PRIVATE_DNS_ZONE_NAME }}
          ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ vars.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
          ACA_MIGRATE_JOB_NAME: ${{ vars.ACA_MIGRATE_JOB_NAME }}
          ACR_PULL_IDENTITY_NAME: ${{ vars.ACR_PULL_IDENTITY_NAME }}
          ACR_NAME: ${{ vars.ACR_NAME }}
          ACR_SKU: ${{ vars.ACR_SKU }}
          POSTGRES_SERVER_NAME: ${{ vars.POSTGRES_SERVER_NAME }}
          POSTGRES_DATABASE_NAME: ${{ vars.POSTGRES_DATABASE_NAME }}
          POSTGRES_ADMIN_USERNAME: ${{ vars.POSTGRES_ADMIN_USERNAME }}
          POSTGRES_VERSION: ${{ vars.POSTGRES_VERSION }}
          POSTGRES_SKU_NAME: ${{ vars.POSTGRES_SKU_NAME }}
          POSTGRES_SKU_TIER: ${{ vars.POSTGRES_SKU_TIER }}
          POSTGRES_STORAGE_MB: ${{ vars.POSTGRES_STORAGE_MB }}
          ENTRA_ISSUER: ${{ vars.ENTRA_ISSUER }}
          ENTRA_AUDIENCE: ${{ vars.ENTRA_AUDIENCE }}
          ENTRA_JWKS_URI: ${{ vars.ENTRA_JWKS_URI }}
        run: |
          set -euo pipefail

          required_vars=(
            AZURE_TENANT_ID
            AZURE_SUBSCRIPTION_ID
            AZURE_RESOURCE_GROUP
            AZURE_LOCATION
            AZURE_VNET_NAME
            AZURE_ACA_SUBNET_NAME
            AZURE_POSTGRES_SUBNET_NAME
            AZURE_PRIVATE_DNS_ZONE_NAME
            ACA_ENVIRONMENT_NAME
            AZURE_LOG_ANALYTICS_WORKSPACE_NAME
            ACA_API_APP_NAME
            ACA_WEB_APP_NAME
            ACA_MIGRATE_JOB_NAME
            ACR_PULL_IDENTITY_NAME
            ACR_NAME
            ACR_SKU
            POSTGRES_SERVER_NAME
            POSTGRES_DATABASE_NAME
            POSTGRES_ADMIN_USERNAME
            POSTGRES_VERSION
            POSTGRES_SKU_NAME
            POSTGRES_SKU_TIER
            POSTGRES_STORAGE_MB
            ENTRA_ISSUER
            ENTRA_AUDIENCE
            ENTRA_JWKS_URI
          )

          for name in "${required_vars[@]}"; do
            value="${!name:-}"
            if [ -z "$value" ]; then
              echo "Missing required GitHub environment variable: $name" >&2
              exit 1
            fi
          done

          private_dns_suffix=".postgres.database.azure.com"
          private_dns_zone_normalized="$(echo "$AZURE_PRIVATE_DNS_ZONE_NAME" | tr '[:upper:]' '[:lower:]')"
          if [[ "$private_dns_zone_normalized" != *"$private_dns_suffix" ]]; then
            echo "AZURE_PRIVATE_DNS_ZONE_NAME must end with the required Postgres DNS suffix (actual: $AZURE_PRIVATE_DNS_ZONE_NAME)" >&2
            exit 1
          fi

          postgres_sku_tier_normalized="$(echo "$POSTGRES_SKU_TIER" | tr '[:upper:]' '[:lower:]')"
          postgres_sku_name_normalized="$(echo "$POSTGRES_SKU_NAME" | tr '[:upper:]' '[:lower:]')"
          if [ "$postgres_sku_tier_normalized" = "burstable" ] && [[ ! "$postgres_sku_name_normalized" =~ ^standard_b ]]; then
            echo "POSTGRES_SKU_NAME must start with Standard_B when POSTGRES_SKU_TIER=Burstable (actual: $POSTGRES_SKU_NAME)" >&2
            exit 1
          fi

          actual_subscription="$(az account show --query id -o tsv)"
          actual_tenant="$(az account show --query tenantId -o tsv)"
          if [ "$actual_subscription" != "$AZURE_SUBSCRIPTION_ID" ]; then
            echo "Azure login is on subscription $actual_subscription (expected $AZURE_SUBSCRIPTION_ID)" >&2
            exit 1
          fi
          if [ "$actual_tenant" != "$AZURE_TENANT_ID" ]; then
            echo "Azure login is on tenant $actual_tenant (expected $AZURE_TENANT_ID)" >&2
            exit 1
          fi

          rg_location_raw="$(az group show --name "$AZURE_RESOURCE_GROUP" --query location -o tsv)"
          rg_location="$(echo "$rg_location_raw" | tr '[:upper:]' '[:lower:]')"
          expected_location="$(echo "$AZURE_LOCATION" | tr '[:upper:]' '[:lower:]')"
          if [ "$rg_location" != "$expected_location" ]; then
            echo "Resource group location is $rg_location_raw (expected $AZURE_LOCATION)" >&2
            exit 1
          fi

          providers=(
            "Microsoft.App"
            "Microsoft.ContainerService"
            "Microsoft.Network"
            "Microsoft.DBforPostgreSQL"
            "Microsoft.OperationalInsights"
          )
          for namespace in "${providers[@]}"; do
            state="$(az provider show --namespace "$namespace" --query registrationState -o tsv)"
            if [ "$state" != "Registered" ]; then
              echo "Registering provider $namespace (current state: $state)"
              az provider register --namespace "$namespace" --wait
            fi
            state="$(az provider show --namespace "$namespace" --query registrationState -o tsv)"
            if [ "$state" != "Registered" ]; then
              echo "Provider $namespace did not reach Registered state (current state: $state)" >&2
              exit 1
            fi
          done

      - name: Ensure ACR ARM authentication is enabled
        env:
          ACR_NAME: ${{ vars.ACR_NAME }}
        run: |
          set -euo pipefail

          arm_auth_status="$(az acr config authentication-as-arm show \
            --registry "$ACR_NAME" \
            --query status \
            --output tsv 2>/dev/null | tr '[:upper:]' '[:lower:]')"

          if [ "$arm_auth_status" != "enabled" ]; then
            echo "Enabling authentication-as-arm for ACR $ACR_NAME (current: ${arm_auth_status:-unknown})"
            az acr config authentication-as-arm update \
              --registry "$ACR_NAME" \
              --status enabled \
              --only-show-errors \
              --output none
          fi

          arm_auth_status="$(az acr config authentication-as-arm show \
            --registry "$ACR_NAME" \
            --query status \
            --output tsv | tr '[:upper:]' '[:lower:]')"

          if [ "$arm_auth_status" != "enabled" ]; then
            echo "ACR authentication-as-arm is not enabled for $ACR_NAME (actual: $arm_auth_status)" >&2
            exit 1
          fi

      - name: Resolve deployment image refs
        id: images
        env:
          EVENT_NAME: ${{ github.event_name }}
          TARGET_IMAGE_TAG: ${{ inputs.image_tag }}
          WORKFLOW_API_IMAGE_REF: ${{ inputs.api_image_ref }}
          WORKFLOW_WEB_IMAGE_REF: ${{ inputs.web_image_ref }}
          ACR_NAME: ${{ vars.ACR_NAME }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
        run: |
          set -euo pipefail

          acr_registry="${ACR_NAME}.azurecr.io"

          resolve_to_digest_ref() {
            local image="$1"

            if [[ "$image" != "$acr_registry/"* ]]; then
              echo "Image is not in expected ACR registry: $image" >&2
              return 1
            fi

            local repo_ref="${image#${acr_registry}/}"
            local repo
            local digest

            if [[ "$repo_ref" == *@sha256:* ]]; then
              repo="${repo_ref%%@*}"
              digest="${repo_ref#*@}"
              local resolved_digest
              resolved_digest="$(az acr repository show \
                --name "$ACR_NAME" \
                --image "$repo@$digest" \
                --query digest \
                --output tsv 2>/dev/null || true)"
              if [ -z "$resolved_digest" ]; then
                echo "Image digest was not found in ACR: $image" >&2
                return 1
              fi
              echo "$acr_registry/$repo@$resolved_digest"
              return
            fi

            repo="${repo_ref%%:*}"
            digest="$(az acr repository show \
              --name "$ACR_NAME" \
              --image "$repo_ref" \
              --query digest \
              --output tsv 2>/dev/null || true)"

            if [ -z "$digest" ]; then
              echo "Image tag was not found in ACR: $image" >&2
              return 1
            fi

            echo "$acr_registry/$repo@$digest"
          }

          resolve_from_tag() {
            local repo="$1"
            local tag="$2"
            resolve_to_digest_ref "$acr_registry/$repo:$tag"
          }

          if [ "$EVENT_NAME" = "workflow_call" ]; then
            if [ -z "${WORKFLOW_API_IMAGE_REF:-}" ] || [ -z "${WORKFLOW_WEB_IMAGE_REF:-}" ]; then
              echo "workflow_call requires api_image_ref and web_image_ref" >&2
              exit 1
            fi
            api_image_ref="$(resolve_to_digest_ref "$WORKFLOW_API_IMAGE_REF")"
            web_image_ref="$(resolve_to_digest_ref "$WORKFLOW_WEB_IMAGE_REF")"
          elif [ -n "${TARGET_IMAGE_TAG:-}" ]; then
            if ! [[ "$TARGET_IMAGE_TAG" =~ ^[A-Za-z0-9][A-Za-z0-9._-]{0,127}$ ]]; then
              echo "Invalid image tag: $TARGET_IMAGE_TAG" >&2
              exit 1
            fi
            api_image_ref="$(resolve_from_tag "compass-api" "$TARGET_IMAGE_TAG")"
            web_image_ref="$(resolve_from_tag "compass-web" "$TARGET_IMAGE_TAG")"
          else
            api_image="$(az containerapp show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$ACA_API_APP_NAME" \
              --query 'properties.template.containers[0].image' \
              --output tsv)"

            web_image="$(az containerapp show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$ACA_WEB_APP_NAME" \
              --query 'properties.template.containers[0].image' \
              --output tsv)"

            api_image_ref="$(resolve_to_digest_ref "$api_image")"
            web_image_ref="$(resolve_to_digest_ref "$web_image")"
          fi

          echo "api_image_ref=$api_image_ref" >> "$GITHUB_OUTPUT"
          echo "web_image_ref=$web_image_ref" >> "$GITHUB_OUTPUT"

      - name: Build runtime parameter overrides
        env:
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_VNET_NAME: ${{ vars.AZURE_VNET_NAME }}
          AZURE_ACA_SUBNET_NAME: ${{ vars.AZURE_ACA_SUBNET_NAME }}
          AZURE_POSTGRES_SUBNET_NAME: ${{ vars.AZURE_POSTGRES_SUBNET_NAME }}
          AZURE_PRIVATE_DNS_ZONE_NAME: ${{ vars.AZURE_PRIVATE_DNS_ZONE_NAME }}
          ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ vars.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
          ACA_MIGRATE_JOB_NAME: ${{ vars.ACA_MIGRATE_JOB_NAME }}
          ACR_PULL_IDENTITY_NAME: ${{ vars.ACR_PULL_IDENTITY_NAME }}
          ACR_NAME: ${{ vars.ACR_NAME }}
          ACR_SKU: ${{ vars.ACR_SKU }}
          POSTGRES_SERVER_NAME: ${{ vars.POSTGRES_SERVER_NAME }}
          POSTGRES_DATABASE_NAME: ${{ vars.POSTGRES_DATABASE_NAME }}
          POSTGRES_ADMIN_USERNAME: ${{ vars.POSTGRES_ADMIN_USERNAME }}
          POSTGRES_VERSION: ${{ vars.POSTGRES_VERSION }}
          POSTGRES_SKU_NAME: ${{ vars.POSTGRES_SKU_NAME }}
          POSTGRES_SKU_TIER: ${{ vars.POSTGRES_SKU_TIER }}
          POSTGRES_STORAGE_MB: ${{ vars.POSTGRES_STORAGE_MB }}
          ENTRA_ISSUER: ${{ vars.ENTRA_ISSUER }}
          ENTRA_AUDIENCE: ${{ vars.ENTRA_AUDIENCE }}
          ENTRA_JWKS_URI: ${{ vars.ENTRA_JWKS_URI }}
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          API_IMAGE_REF: ${{ steps.images.outputs.api_image_ref }}
          WEB_IMAGE_REF: ${{ steps.images.outputs.web_image_ref }}
        run: |
          set -euo pipefail
          mkdir -p ".artifacts/infra/$HEAD_SHA"

          if [ -z "${POSTGRES_ADMIN_PASSWORD:-}" ]; then
            echo "Missing required GitHub environment secret: POSTGRES_ADMIN_PASSWORD" >&2
            exit 1
          fi

          jq -n \
            --arg location "$AZURE_LOCATION" \
            --arg vnetName "$AZURE_VNET_NAME" \
            --arg acaSubnetName "$AZURE_ACA_SUBNET_NAME" \
            --arg postgresSubnetName "$AZURE_POSTGRES_SUBNET_NAME" \
            --arg privateDnsZoneName "$AZURE_PRIVATE_DNS_ZONE_NAME" \
            --arg environmentName "$ACA_ENVIRONMENT_NAME" \
            --arg logAnalyticsWorkspaceName "$AZURE_LOG_ANALYTICS_WORKSPACE_NAME" \
            --arg apiAppName "$ACA_API_APP_NAME" \
            --arg webAppName "$ACA_WEB_APP_NAME" \
            --arg migrationJobName "$ACA_MIGRATE_JOB_NAME" \
            --arg acrPullIdentityName "$ACR_PULL_IDENTITY_NAME" \
            --arg acrName "$ACR_NAME" \
            --arg acrSku "$ACR_SKU" \
            --arg postgresServerName "$POSTGRES_SERVER_NAME" \
            --arg postgresDatabaseName "$POSTGRES_DATABASE_NAME" \
            --arg postgresAdminUsername "$POSTGRES_ADMIN_USERNAME" \
            --arg postgresVersion "$POSTGRES_VERSION" \
            --arg postgresSkuName "$POSTGRES_SKU_NAME" \
            --arg postgresSkuTier "$POSTGRES_SKU_TIER" \
            --arg postgresStorageMb "$POSTGRES_STORAGE_MB" \
            --arg postgresAdminPassword "$POSTGRES_ADMIN_PASSWORD" \
            --arg apiImage "$API_IMAGE_REF" \
            --arg webImage "$WEB_IMAGE_REF" \
            --arg entraIssuer "$ENTRA_ISSUER" \
            --arg entraAudience "$ENTRA_AUDIENCE" \
            --arg entraJwksUri "$ENTRA_JWKS_URI" \
            '{
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "location": {"value": $location},
                "vnetName": {"value": $vnetName},
                "acaSubnetName": {"value": $acaSubnetName},
                "postgresSubnetName": {"value": $postgresSubnetName},
                "privateDnsZoneName": {"value": $privateDnsZoneName},
                "environmentName": {"value": $environmentName},
                "logAnalyticsWorkspaceName": {"value": $logAnalyticsWorkspaceName},
                "apiAppName": {"value": $apiAppName},
                "webAppName": {"value": $webAppName},
                "migrationJobName": {"value": $migrationJobName},
                "acrPullIdentityName": {"value": $acrPullIdentityName},
                "acrName": {"value": $acrName},
                "acrSku": {"value": $acrSku},
                "postgresServerName": {"value": $postgresServerName},
                "postgresDatabaseName": {"value": $postgresDatabaseName},
                "postgresAdminUsername": {"value": $postgresAdminUsername},
                "postgresVersion": {"value": $postgresVersion},
                "postgresSkuName": {"value": $postgresSkuName},
                "postgresSkuTier": {"value": $postgresSkuTier},
                "postgresStorageMb": {"value": ($postgresStorageMb | tonumber)},
                "postgresAdminPassword": {"value": $postgresAdminPassword},
                "apiImage": {"value": $apiImage},
                "webImage": {"value": $webImage},
                "entraIssuer": {"value": $entraIssuer},
                "entraAudience": {"value": $entraAudience},
                "entraJwksUri": {"value": $entraJwksUri}
              }
            }' > ".artifacts/infra/$HEAD_SHA/runtime.parameters.json"

      - name: Validate Bicep template
        run: |
          az bicep version
          az deployment group validate \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --template-file infra/azure/main.bicep \
            --parameters @.artifacts/infra/$HEAD_SHA/runtime.parameters.json

      - name: Apply Bicep template
        run: |
          set -euo pipefail

          mkdir -p ".artifacts/infra/$HEAD_SHA"
          stderr_path=".artifacts/infra/$HEAD_SHA/deployment.stderr.log"
          attempts_path=".artifacts/infra/$HEAD_SHA/deployment-attempts.log"
          : > "$attempts_path"

          transient_pattern='(OperationExpired|GatewayTimeout|TooManyRequests|ResourceNotReady|another operation is in progress|OperationInProgress|retryable|temporar|timeout|timed out)'

          run_apply() {
            az deployment group create \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --template-file infra/azure/main.bicep \
              --parameters @.artifacts/infra/$HEAD_SHA/runtime.parameters.json \
              --output json > .artifacts/infra/$HEAD_SHA/deployment.json 2> "$stderr_path"
          }

          for attempt in 1 2; do
            echo "attempt=$attempt startedAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$attempts_path"

            if run_apply; then
              echo "attempt=$attempt status=success finishedAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$attempts_path"
              exit 0
            fi

            if [ "$attempt" -eq 1 ] && grep -Eiq "$transient_pattern" "$stderr_path"; then
              echo "attempt=$attempt status=retry transient=true finishedAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$attempts_path"
              echo "Transient infra apply failure detected; retrying once in 20 seconds..."
              sleep 20
              continue
            fi

            echo "attempt=$attempt status=failed transient=false finishedAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$attempts_path"
            echo "Infra apply failed with terminal diagnostics:" >&2
            cat "$stderr_path" >&2
            exit 1
          done

      - name: Upload infra artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: infra-apply-${{ env.HEAD_SHA }}
          path: |
            .artifacts/infra/${{ env.HEAD_SHA }}/deployment.json
            .artifacts/infra/${{ env.HEAD_SHA }}/runtime.parameters.json
          if-no-files-found: warn
