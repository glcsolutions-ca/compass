name: Infra Apply

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: Optional image tag for API/Web/migrate images (when set, always used)
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - infra/azure/**
      - .github/workflows/infra-apply.yml

permissions:
  contents: read
  id-token: write

jobs:
  bicep_apply:
    name: infra-apply
    environment: production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HEAD_SHA: ${{ github.sha }}
      TARGET_IMAGE_TAG: ${{ inputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve image tag
        run: |
          set -euo pipefail
          image_tag="${TARGET_IMAGE_TAG:-}"
          from_input=false
          if [ -n "$image_tag" ]; then
            from_input=true
          else
            image_tag="$HEAD_SHA"
          fi

          if ! [[ "$image_tag" =~ ^[A-Za-z0-9][A-Za-z0-9._-]{0,127}$ ]]; then
            echo "Invalid image tag: $image_tag" >&2
            exit 1
          fi

          echo "RESOLVED_IMAGE_TAG=$image_tag" >> "$GITHUB_ENV"
          echo "IMAGE_TAG_FROM_INPUT=$from_input" >> "$GITHUB_ENV"

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_DEPLOY_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Preflight Azure context, region, vars, and providers
        env:
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_VNET_NAME: ${{ vars.AZURE_VNET_NAME }}
          AZURE_ACA_SUBNET_NAME: ${{ vars.AZURE_ACA_SUBNET_NAME }}
          AZURE_POSTGRES_SUBNET_NAME: ${{ vars.AZURE_POSTGRES_SUBNET_NAME }}
          AZURE_PRIVATE_DNS_ZONE_NAME: ${{ vars.AZURE_PRIVATE_DNS_ZONE_NAME }}
          ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ vars.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
          ACA_MIGRATE_JOB_NAME: ${{ vars.ACA_MIGRATE_JOB_NAME }}
          ACR_PULL_IDENTITY_NAME: ${{ vars.ACR_PULL_IDENTITY_NAME }}
          ACR_NAME: ${{ vars.ACR_NAME }}
          ACR_SKU: ${{ vars.ACR_SKU }}
          POSTGRES_SERVER_NAME: ${{ vars.POSTGRES_SERVER_NAME }}
          POSTGRES_DATABASE_NAME: ${{ vars.POSTGRES_DATABASE_NAME }}
          POSTGRES_ADMIN_USERNAME: ${{ vars.POSTGRES_ADMIN_USERNAME }}
          POSTGRES_VERSION: ${{ vars.POSTGRES_VERSION }}
          POSTGRES_SKU_NAME: ${{ vars.POSTGRES_SKU_NAME }}
          POSTGRES_SKU_TIER: ${{ vars.POSTGRES_SKU_TIER }}
          POSTGRES_STORAGE_MB: ${{ vars.POSTGRES_STORAGE_MB }}
          ENTRA_ISSUER: ${{ vars.ENTRA_ISSUER }}
          ENTRA_AUDIENCE: ${{ vars.ENTRA_AUDIENCE }}
          ENTRA_JWKS_URI: ${{ vars.ENTRA_JWKS_URI }}
        run: |
          set -euo pipefail

          required_vars=(
            AZURE_TENANT_ID
            AZURE_SUBSCRIPTION_ID
            AZURE_RESOURCE_GROUP
            AZURE_LOCATION
            AZURE_VNET_NAME
            AZURE_ACA_SUBNET_NAME
            AZURE_POSTGRES_SUBNET_NAME
            AZURE_PRIVATE_DNS_ZONE_NAME
            ACA_ENVIRONMENT_NAME
            AZURE_LOG_ANALYTICS_WORKSPACE_NAME
            ACA_API_APP_NAME
            ACA_WEB_APP_NAME
            ACA_MIGRATE_JOB_NAME
            ACR_PULL_IDENTITY_NAME
            ACR_NAME
            ACR_SKU
            POSTGRES_SERVER_NAME
            POSTGRES_DATABASE_NAME
            POSTGRES_ADMIN_USERNAME
            POSTGRES_VERSION
            POSTGRES_SKU_NAME
            POSTGRES_SKU_TIER
            POSTGRES_STORAGE_MB
            ENTRA_ISSUER
            ENTRA_AUDIENCE
            ENTRA_JWKS_URI
          )

          for name in "${required_vars[@]}"; do
            value="${!name:-}"
            if [ -z "$value" ]; then
              echo "Missing required GitHub environment variable: $name" >&2
              exit 1
            fi
          done

          actual_subscription="$(az account show --query id -o tsv)"
          actual_tenant="$(az account show --query tenantId -o tsv)"
          if [ "$actual_subscription" != "$AZURE_SUBSCRIPTION_ID" ]; then
            echo "Azure login is on subscription $actual_subscription (expected $AZURE_SUBSCRIPTION_ID)" >&2
            exit 1
          fi
          if [ "$actual_tenant" != "$AZURE_TENANT_ID" ]; then
            echo "Azure login is on tenant $actual_tenant (expected $AZURE_TENANT_ID)" >&2
            exit 1
          fi

          rg_location_raw="$(az group show --name "$AZURE_RESOURCE_GROUP" --query location -o tsv)"
          rg_location="$(echo "$rg_location_raw" | tr '[:upper:]' '[:lower:]')"
          expected_location="$(echo "$AZURE_LOCATION" | tr '[:upper:]' '[:lower:]')"
          if [ "$rg_location" != "$expected_location" ]; then
            echo "Resource group location is $rg_location_raw (expected $AZURE_LOCATION)" >&2
            exit 1
          fi

          providers=(
            "Microsoft.App"
            "Microsoft.ContainerService"
            "Microsoft.Network"
            "Microsoft.DBforPostgreSQL"
            "Microsoft.OperationalInsights"
          )
          for namespace in "${providers[@]}"; do
            state="$(az provider show --namespace "$namespace" --query registrationState -o tsv)"
            if [ "$state" != "Registered" ]; then
              echo "Registering provider $namespace (current state: $state)"
              az provider register --namespace "$namespace" --wait
            fi
            state="$(az provider show --namespace "$namespace" --query registrationState -o tsv)"
            if [ "$state" != "Registered" ]; then
              echo "Provider $namespace did not reach Registered state (current state: $state)" >&2
              exit 1
            fi
          done

      - name: Resolve deployment images
        id: images
        env:
          ACR_NAME: ${{ vars.ACR_NAME }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
          ACA_MIGRATE_JOB_NAME: ${{ vars.ACA_MIGRATE_JOB_NAME }}
        run: |
          set -euo pipefail

          acr_registry="${ACR_NAME}.azurecr.io"

          if [ "${IMAGE_TAG_FROM_INPUT:-false}" = "true" ]; then
            api_image="${acr_registry}/compass-api:${RESOLVED_IMAGE_TAG}"
            web_image="${acr_registry}/compass-web:${RESOLVED_IMAGE_TAG}"
            migrate_image="${acr_registry}/compass-migrate:${RESOLVED_IMAGE_TAG}"
          else
            api_image="$(az containerapp show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$ACA_API_APP_NAME" \
              --query 'properties.template.containers[0].image' \
              --output tsv 2>/dev/null || true)"

            web_image="$(az containerapp show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$ACA_WEB_APP_NAME" \
              --query 'properties.template.containers[0].image' \
              --output tsv 2>/dev/null || true)"

            migrate_image="$(az containerapp job show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$ACA_MIGRATE_JOB_NAME" \
              --query 'properties.template.containers[0].image' \
              --output tsv 2>/dev/null || true)"

            if [ -z "$api_image" ]; then
              api_image="${acr_registry}/compass-api:${RESOLVED_IMAGE_TAG}"
            fi
            if [ -z "$web_image" ]; then
              web_image="${acr_registry}/compass-web:${RESOLVED_IMAGE_TAG}"
            fi
            if [ -z "$migrate_image" ]; then
              migrate_image="${acr_registry}/compass-migrate:${RESOLVED_IMAGE_TAG}"
            fi
          fi

          echo "api_image=$api_image" >> "$GITHUB_OUTPUT"
          echo "web_image=$web_image" >> "$GITHUB_OUTPUT"
          echo "migrate_image=$migrate_image" >> "$GITHUB_OUTPUT"

      - name: Build Bicep params JSON
        run: |
          mkdir -p ".artifacts/infra/$HEAD_SHA"
          az bicep build-params \
            --file infra/azure/environments/prod.bicepparam \
            --outfile ".artifacts/infra/$HEAD_SHA/prod.parameters.json"

      - name: Build runtime parameter overrides
        env:
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_VNET_NAME: ${{ vars.AZURE_VNET_NAME }}
          AZURE_ACA_SUBNET_NAME: ${{ vars.AZURE_ACA_SUBNET_NAME }}
          AZURE_POSTGRES_SUBNET_NAME: ${{ vars.AZURE_POSTGRES_SUBNET_NAME }}
          AZURE_PRIVATE_DNS_ZONE_NAME: ${{ vars.AZURE_PRIVATE_DNS_ZONE_NAME }}
          ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ vars.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
          ACA_MIGRATE_JOB_NAME: ${{ vars.ACA_MIGRATE_JOB_NAME }}
          ACR_PULL_IDENTITY_NAME: ${{ vars.ACR_PULL_IDENTITY_NAME }}
          ACR_NAME: ${{ vars.ACR_NAME }}
          ACR_SKU: ${{ vars.ACR_SKU }}
          POSTGRES_SERVER_NAME: ${{ vars.POSTGRES_SERVER_NAME }}
          POSTGRES_DATABASE_NAME: ${{ vars.POSTGRES_DATABASE_NAME }}
          POSTGRES_ADMIN_USERNAME: ${{ vars.POSTGRES_ADMIN_USERNAME }}
          POSTGRES_VERSION: ${{ vars.POSTGRES_VERSION }}
          POSTGRES_SKU_NAME: ${{ vars.POSTGRES_SKU_NAME }}
          POSTGRES_SKU_TIER: ${{ vars.POSTGRES_SKU_TIER }}
          POSTGRES_STORAGE_MB: ${{ vars.POSTGRES_STORAGE_MB }}
          ENTRA_ISSUER: ${{ vars.ENTRA_ISSUER }}
          ENTRA_AUDIENCE: ${{ vars.ENTRA_AUDIENCE }}
          ENTRA_JWKS_URI: ${{ vars.ENTRA_JWKS_URI }}
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          WEB_BEARER_TOKEN: ${{ secrets.WEB_BEARER_TOKEN }}
          API_IMAGE: ${{ steps.images.outputs.api_image }}
          WEB_IMAGE: ${{ steps.images.outputs.web_image }}
          MIGRATE_IMAGE: ${{ steps.images.outputs.migrate_image }}
        run: |
          set -euo pipefail

          if [ -z "${POSTGRES_ADMIN_PASSWORD:-}" ]; then
            echo "Missing required GitHub environment secret: POSTGRES_ADMIN_PASSWORD" >&2
            exit 1
          fi

          jq -n \
            --arg location "$AZURE_LOCATION" \
            --arg vnetName "$AZURE_VNET_NAME" \
            --arg acaSubnetName "$AZURE_ACA_SUBNET_NAME" \
            --arg postgresSubnetName "$AZURE_POSTGRES_SUBNET_NAME" \
            --arg privateDnsZoneName "$AZURE_PRIVATE_DNS_ZONE_NAME" \
            --arg environmentName "$ACA_ENVIRONMENT_NAME" \
            --arg logAnalyticsWorkspaceName "$AZURE_LOG_ANALYTICS_WORKSPACE_NAME" \
            --arg apiAppName "$ACA_API_APP_NAME" \
            --arg webAppName "$ACA_WEB_APP_NAME" \
            --arg migrationJobName "$ACA_MIGRATE_JOB_NAME" \
            --arg acrPullIdentityName "$ACR_PULL_IDENTITY_NAME" \
            --arg acrName "$ACR_NAME" \
            --arg acrSku "$ACR_SKU" \
            --arg postgresServerName "$POSTGRES_SERVER_NAME" \
            --arg postgresDatabaseName "$POSTGRES_DATABASE_NAME" \
            --arg postgresAdminUsername "$POSTGRES_ADMIN_USERNAME" \
            --arg postgresVersion "$POSTGRES_VERSION" \
            --arg postgresSkuName "$POSTGRES_SKU_NAME" \
            --arg postgresSkuTier "$POSTGRES_SKU_TIER" \
            --arg postgresStorageMb "$POSTGRES_STORAGE_MB" \
            --arg postgresAdminPassword "$POSTGRES_ADMIN_PASSWORD" \
            --arg webBearerToken "${WEB_BEARER_TOKEN:-}" \
            --arg apiImage "$API_IMAGE" \
            --arg webImage "$WEB_IMAGE" \
            --arg migrateImage "$MIGRATE_IMAGE" \
            --arg entraIssuer "$ENTRA_ISSUER" \
            --arg entraAudience "$ENTRA_AUDIENCE" \
            --arg entraJwksUri "$ENTRA_JWKS_URI" \
            '{
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "location": {"value": $location},
                "vnetName": {"value": $vnetName},
                "acaSubnetName": {"value": $acaSubnetName},
                "postgresSubnetName": {"value": $postgresSubnetName},
                "privateDnsZoneName": {"value": $privateDnsZoneName},
                "environmentName": {"value": $environmentName},
                "logAnalyticsWorkspaceName": {"value": $logAnalyticsWorkspaceName},
                "apiAppName": {"value": $apiAppName},
                "webAppName": {"value": $webAppName},
                "migrationJobName": {"value": $migrationJobName},
                "acrPullIdentityName": {"value": $acrPullIdentityName},
                "acrName": {"value": $acrName},
                "acrSku": {"value": $acrSku},
                "postgresServerName": {"value": $postgresServerName},
                "postgresDatabaseName": {"value": $postgresDatabaseName},
                "postgresAdminUsername": {"value": $postgresAdminUsername},
                "postgresVersion": {"value": $postgresVersion},
                "postgresSkuName": {"value": $postgresSkuName},
                "postgresSkuTier": {"value": $postgresSkuTier},
                "postgresStorageMb": {"value": ($postgresStorageMb | tonumber)},
                "postgresAdminPassword": {"value": $postgresAdminPassword},
                "webBearerToken": {"value": $webBearerToken},
                "apiImage": {"value": $apiImage},
                "webImage": {"value": $webImage},
                "migrateImage": {"value": $migrateImage},
                "entraIssuer": {"value": $entraIssuer},
                "entraAudience": {"value": $entraAudience},
                "entraJwksUri": {"value": $entraJwksUri}
              }
            }' > ".artifacts/infra/$HEAD_SHA/runtime.parameters.json"

      - name: Validate Bicep template
        run: |
          az bicep version
          az deployment group validate \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --template-file infra/azure/main.bicep \
            --parameters @.artifacts/infra/$HEAD_SHA/prod.parameters.json \
            --parameters @.artifacts/infra/$HEAD_SHA/runtime.parameters.json

      - name: Apply Bicep template
        run: |
          az deployment group create \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --template-file infra/azure/main.bicep \
            --parameters @.artifacts/infra/$HEAD_SHA/prod.parameters.json \
            --parameters @.artifacts/infra/$HEAD_SHA/runtime.parameters.json \
            --output json > .artifacts/infra/$HEAD_SHA/deployment.json

      - name: Ensure Azure CLI containerapp extension
        run: az extension add --name containerapp --upgrade --only-show-errors

      - name: Deactivate zero-traffic active revisions
        env:
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          ACA_API_APP_NAME: ${{ vars.ACA_API_APP_NAME }}
          ACA_WEB_APP_NAME: ${{ vars.ACA_WEB_APP_NAME }}
        run: |
          set -euo pipefail

          for app in "$ACA_API_APP_NAME" "$ACA_WEB_APP_NAME"; do
            mapfile -t revisions < <(az containerapp revision list \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$app" \
              --query "[?properties.active==\`true\` && properties.trafficWeight==\`0\`].name" \
              --output tsv)

            if [ "${#revisions[@]}" -eq 0 ]; then
              echo "No zero-traffic active revisions to deactivate for $app"
              continue
            fi

            for revision in "${revisions[@]}"; do
              echo "Deactivating zero-traffic revision $revision for $app"
              az containerapp revision deactivate \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --name "$app" \
                --revision "$revision" \
                --only-show-errors || true
            done
          done

      - name: Upload infra artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: infra-apply-${{ env.HEAD_SHA }}
          path: |
            .artifacts/infra/${{ env.HEAD_SHA }}/deployment.json
            .artifacts/infra/${{ env.HEAD_SHA }}/prod.parameters.json
            .artifacts/infra/${{ env.HEAD_SHA }}/runtime.parameters.json
          if-no-files-found: warn
