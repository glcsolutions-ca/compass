name: Merge Contract

permissions:
  contents: read
  pull-requests: read

env:
  EXPECTED_ENTRYPOINT: /

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

jobs:
  preflight:
    name: risk-policy-preflight
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TEST_POLICY_PATH: tests/policy/test-policy.json
    outputs:
      preflight_path: ${{ steps.preflight.outputs.preflight_path }}
      base_sha: ${{ steps.preflight.outputs.base_sha }}
      head_sha: ${{ steps.preflight.outputs.head_sha }}
      tested_sha: ${{ steps.preflight.outputs.tested_sha }}
      pr_number: ${{ steps.preflight.outputs.pr_number }}
      tier: ${{ steps.preflight.outputs.tier }}
      ci_mode: ${{ steps.preflight.outputs.ci_mode }}
      changed_files_json: ${{ steps.preflight.outputs.changed_files_json }}
      required_flow_ids_json: ${{ steps.preflight.outputs.required_flow_ids_json }}
      browser_required: ${{ steps.preflight.outputs.browser_required }}
      harness_required: ${{ steps.preflight.outputs.harness_required }}
      migration_image_required: ${{ steps.preflight.outputs.migration_image_required }}
      docs_drift_blocking: ${{ steps.preflight.outputs.docs_drift_blocking }}
      docs_drift_path: ${{ steps.docs_drift.outputs.docs_drift_path }}
      docs_drift_status: ${{ steps.docs_drift.outputs.docs_drift_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Run preflight
        id: preflight
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          GITHUB_TESTED_SHA: ${{ github.sha }}
        run: node scripts/ci/preflight.mjs

      - name: Upload preflight artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: preflight-${{ steps.preflight.outputs.tested_sha }}
          path: ${{ steps.preflight.outputs.preflight_path }}
          if-no-files-found: warn

      - name: Run testing contract
        id: testing_contract
        continue-on-error: true
        env:
          HEAD_SHA: ${{ steps.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ steps.preflight.outputs.tested_sha }}
        run: node scripts/ci/testing-contract.mjs

      - name: Upload testing-contract artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: testing-contract-${{ steps.preflight.outputs.tested_sha }}
          path: .artifacts/testing-contract/${{ steps.preflight.outputs.tested_sha }}/result.json
          if-no-files-found: warn

      - name: Fail on testing-contract violations
        if: ${{ steps.testing_contract.outcome != 'success' }}
        run: exit 1

      - name: Evaluate docs drift
        id: docs_drift
        env:
          HEAD_SHA: ${{ steps.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ steps.preflight.outputs.tested_sha }}
          RISK_TIER: ${{ steps.preflight.outputs.tier }}
          CHANGED_FILES_JSON: ${{ steps.preflight.outputs.changed_files_json }}
        run: node scripts/ci/docs-drift.mjs

      - name: Lint changed workflow files
        if: ${{ steps.preflight.outcome == 'success' }}
        env:
          CHANGED_FILES_JSON: ${{ steps.preflight.outputs.changed_files_json }}
        run: |
          set -euo pipefail

          mapfile -t workflow_files < <(
            node <<'NODE'
          const fs = require("node:fs");
          const changedFiles = JSON.parse(process.env.CHANGED_FILES_JSON || "[]");
          const workflows = [
            ...new Set(
              changedFiles.filter(
                (filePath) =>
                  /^\.github\/workflows\/.*\.(yml|yaml)$/.test(filePath) && fs.existsSync(filePath)
              )
            )
          ];
          for (const workflow of workflows) {
            console.log(workflow);
          }
          NODE
          )

          if [ "${#workflow_files[@]}" -eq 0 ]; then
            echo "No workflow files to lint."
            exit 0
          fi

          docker run --rm \
            -v "$PWD:/work" \
            -w /work \
            rhysd/actionlint:1.7.11 \
            -shellcheck= \
            -color "${workflow_files[@]}"

      - name: Upload docs-drift artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: docs-drift-${{ steps.preflight.outputs.tested_sha }}
          path: .artifacts/docs-drift/${{ steps.preflight.outputs.tested_sha }}/result.json
          if-no-files-found: warn

  ci_pipeline:
    name: ci-pipeline
    needs:
      - preflight
    runs-on: ubuntu-latest
    timeout-minutes: 35
    env:
      TEST_POLICY_PATH: tests/policy/test-policy.json
    outputs:
      ci_pipeline_path: ${{ steps.write_result.outputs.ci_pipeline_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start Postgres (full mode only)
        if: ${{ needs.preflight.outputs.ci_mode == 'full' }}
        run: |
          set -euo pipefail
          docker run -d \
            --name ci-postgres \
            -e POSTGRES_DB=compass \
            -e POSTGRES_USER=compass \
            -e POSTGRES_PASSWORD=compass \
            -p 5432:5432 \
            postgres:16-alpine

      - name: Run ci-pipeline by mode
        env:
          CI_MODE: ${{ needs.preflight.outputs.ci_mode }}
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
          DATABASE_URL: postgres://compass:compass@127.0.0.1:5432/compass
        run: |
          set -euo pipefail

          if [ "$CI_MODE" = "fast" ]; then
            pnpm test
            exit 0
          fi

          pnpm db:postgres:wait
          pnpm db:migrate:up
          pnpm db:seed
          pnpm test:full
          pnpm build

      - name: Stop Postgres (full mode only)
        if: ${{ always() && needs.preflight.outputs.ci_mode == 'full' }}
        run: |
          docker rm -f ci-postgres >/dev/null 2>&1 || true

      - name: Write ci-pipeline artifact
        if: ${{ always() }}
        id: write_result
        env:
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
          CI_MODE: ${{ needs.preflight.outputs.ci_mode }}
          CI_STATUS: ${{ job.status }}
        run: |
          mkdir -p .artifacts/ci-pipeline/$TESTED_SHA
          cat > .artifacts/ci-pipeline/$TESTED_SHA/result.json <<JSON
          {
            "schemaVersion": "1",
            "generatedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "headSha": "$HEAD_SHA",
            "testedSha": "$TESTED_SHA",
            "tier": "$RISK_TIER",
            "mode": "$CI_MODE",
            "status": "$CI_STATUS"
          }
          JSON
          echo "ci_pipeline_path=.artifacts/ci-pipeline/$TESTED_SHA/result.json" >> "$GITHUB_OUTPUT"

      - name: Upload ci-pipeline artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-pipeline-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/ci-pipeline/${{ needs.preflight.outputs.tested_sha }}/result.json
          if-no-files-found: warn

  browser_evidence:
    name: browser-evidence
    needs:
      - preflight
    if: ${{ needs.preflight.outputs.browser_required == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 35
    outputs:
      browser_manifest_path: ${{ steps.browser_paths.outputs.browser_manifest_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium

      - name: Build contracts package
        run: pnpm --filter @compass/contracts build

      - name: Build API
        run: pnpm --filter @compass/api build

      - name: Build Web
        run: pnpm --filter @compass/web build

      - name: Prepare Web standalone assets
        run: |
          rm -rf apps/web/.next/standalone/apps/web/.next/static
          rm -rf apps/web/.next/standalone/apps/web/public
          mkdir -p apps/web/.next/standalone/apps/web/.next
          mkdir -p apps/web/.next/standalone/apps/web/public
          cp -R apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static
          if [ -d apps/web/public ]; then
            cp -R apps/web/public/. apps/web/.next/standalone/apps/web/public/
          fi

      - name: Start API server
        run: |
          pnpm --filter @compass/api start > /tmp/compass-api.log 2>&1 &
          echo $! > /tmp/compass-api.pid

      - name: Wait for API readiness
        run: |
          for i in $(seq 1 60); do
            if curl --silent --fail http://127.0.0.1:3001/health > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          cat /tmp/compass-api.log || true
          exit 1

      - name: Start Web server
        env:
          API_BASE_URL: http://127.0.0.1:3001
        run: |
          pnpm --filter @compass/web start:standalone > /tmp/compass-web.log 2>&1 &
          echo $! > /tmp/compass-web.pid

      - name: Wait for Web readiness
        run: |
          for i in $(seq 1 90); do
            if curl --silent --fail http://127.0.0.1:3000 > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          cat /tmp/compass-web.log || true
          exit 1

      - name: Run browser-evidence
        env:
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          PR_NUMBER: ${{ needs.preflight.outputs.pr_number }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
          WEB_BASE_URL: http://127.0.0.1:3000
          EXPECTED_ENTRYPOINT: ${{ env.EXPECTED_ENTRYPOINT }}
          REQUIRED_FLOW_IDS_JSON: ${{ needs.preflight.outputs.required_flow_ids_json }}
        run: pnpm ci:browser-evidence

      - name: Set browser evidence outputs
        id: browser_paths
        if: ${{ always() }}
        env:
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
        run: echo "browser_manifest_path=.artifacts/browser-evidence/$TESTED_SHA/manifest.json" >> "$GITHUB_OUTPUT"

      - name: Upload browser-evidence artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: browser-evidence-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/browser-evidence/${{ needs.preflight.outputs.tested_sha }}
          if-no-files-found: warn

      - name: Stop background servers
        if: ${{ always() }}
        run: |
          if [ -f /tmp/compass-web.pid ]; then
            kill "$(cat /tmp/compass-web.pid)" || true
          fi
          if [ -f /tmp/compass-api.pid ]; then
            kill "$(cat /tmp/compass-api.pid)" || true
          fi

      - name: Print server logs on failure
        if: ${{ failure() }}
        run: |
          echo "--- API LOG ---"
          cat /tmp/compass-api.log || true
          echo "--- WEB LOG ---"
          cat /tmp/compass-web.log || true

  harness_smoke:
    name: harness-smoke
    needs:
      - preflight
    if: ${{ needs.preflight.outputs.harness_required == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      harness_smoke_path: ${{ steps.harness_paths.outputs.harness_smoke_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run harness-smoke
        id: harness_smoke
        env:
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
        run: pnpm ci:harness-smoke

      - name: Set harness-smoke outputs
        id: harness_paths
        if: ${{ always() }}
        env:
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
        run: echo "harness_smoke_path=.artifacts/harness-smoke/$TESTED_SHA/result.json" >> "$GITHUB_OUTPUT"

      - name: Upload harness-smoke artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: harness-smoke-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/harness-smoke/${{ needs.preflight.outputs.tested_sha }}/result.json
          if-no-files-found: warn

  migration_image_smoke:
    name: migration-image-smoke
    needs:
      - preflight
    if: ${{ needs.preflight.outputs.migration_image_required == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      migration_image_smoke_path: ${{ steps.write_result.outputs.migration_image_smoke_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run migration-image-smoke
        id: run_smoke
        continue-on-error: true
        env:
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
        run: |
          set -euo pipefail
          artifact_dir=".artifacts/migration-image-smoke/$TESTED_SHA"
          mkdir -p "$artifact_dir"
          log_path="$artifact_dir/run.log"
          network_name="migration-image-smoke-net"
          postgres_name="migration-image-smoke-postgres"

          {
            docker network create "$network_name"

            docker run -d \
              --name "$postgres_name" \
              --network "$network_name" \
              -e POSTGRES_DB=compass \
              -e POSTGRES_USER=compass \
              -e POSTGRES_PASSWORD=compass \
              postgres:16-alpine

            for i in $(seq 1 90); do
              if docker exec "$postgres_name" pg_isready -U compass -d compass >/dev/null 2>&1; then
                break
              fi

              if [ "$i" -eq 90 ]; then
                echo "Timed out waiting for postgres in migration-image-smoke job" >&2
                exit 1
              fi

              sleep 1
            done

            docker build -f apps/api/Dockerfile -t "compass-api-migration-smoke:$TESTED_SHA" .

            docker run --rm \
              --network "$network_name" \
              -e DATABASE_URL="postgres://compass:compass@$postgres_name:5432/compass" \
              "compass-api-migration-smoke:$TESTED_SHA" \
              node db/scripts/migrate.mjs up
          } 2>&1 | tee "$log_path"

      - name: Write migration-image-smoke artifact
        if: ${{ always() }}
        id: write_result
        env:
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
          SMOKE_OUTCOME: ${{ steps.run_smoke.outcome }}
        run: |
          set -euo pipefail
          artifact_dir=".artifacts/migration-image-smoke/$TESTED_SHA"
          mkdir -p "$artifact_dir"

          status="pass"
          reason_code=""
          if [ "$SMOKE_OUTCOME" != "success" ]; then
            status="fail"
            reason_code="MIGRATION_IMAGE_SMOKE_FAILED"
          fi

          cat > "$artifact_dir/result.json" <<JSON
          {
            "schemaVersion": "1",
            "generatedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "headSha": "$HEAD_SHA",
            "testedSha": "$TESTED_SHA",
            "tier": "$RISK_TIER",
            "status": "$status",
            "reasonCode": "$reason_code",
            "logPath": "$artifact_dir/run.log"
          }
          JSON

          echo "migration_image_smoke_path=$artifact_dir/result.json" >> "$GITHUB_OUTPUT"

      - name: Stop migration-image-smoke services
        if: ${{ always() }}
        run: |
          docker rm -f migration-image-smoke-postgres >/dev/null 2>&1 || true
          docker network rm migration-image-smoke-net >/dev/null 2>&1 || true

      - name: Upload migration-image-smoke artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: migration-image-smoke-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/migration-image-smoke/${{ needs.preflight.outputs.tested_sha }}
          if-no-files-found: warn

      - name: Fail when migration-image-smoke fails
        if: ${{ steps.run_smoke.outcome != 'success' }}
        run: exit 1

  risk_policy_gate:
    name: risk-policy-gate
    if: ${{ always() }}
    needs:
      - preflight
      - ci_pipeline
      - browser_evidence
      - harness_smoke
      - migration_image_smoke
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Download browser-evidence artifact
        if: ${{ needs.preflight.outputs.browser_required == 'true' && needs.browser_evidence.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: browser-evidence-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/browser-evidence/${{ needs.preflight.outputs.tested_sha }}

      - name: Enforce merge contract
        env:
          HEAD_SHA: ${{ needs.preflight.outputs.head_sha }}
          TESTED_SHA: ${{ needs.preflight.outputs.tested_sha }}
          RISK_TIER: ${{ needs.preflight.outputs.tier }}
          BROWSER_REQUIRED: ${{ needs.preflight.outputs.browser_required }}
          HARNESS_REQUIRED: ${{ needs.preflight.outputs.harness_required }}
          MIGRATION_IMAGE_REQUIRED: ${{ needs.preflight.outputs.migration_image_required }}
          DOCS_DRIFT_BLOCKING: ${{ needs.preflight.outputs.docs_drift_blocking }}
          DOCS_DRIFT_STATUS: ${{ needs.preflight.outputs.docs_drift_status }}
          REQUIRED_FLOW_IDS_JSON: ${{ needs.preflight.outputs.required_flow_ids_json }}
          CHECK_RESULTS_JSON: ${{ format('{{"preflight":"{0}","ci-pipeline":"{1}","browser-evidence":"{2}","harness-smoke":"{3}","migration-image-smoke":"{4}"}}', needs.preflight.result, needs.ci_pipeline.result, needs.browser_evidence.result, needs.harness_smoke.result, needs.migration_image_smoke.result) }}
          BROWSER_EVIDENCE_MANIFEST_PATH: ${{ needs.browser_evidence.outputs.browser_manifest_path }}
          EXPECTED_ENTRYPOINT: ${{ env.EXPECTED_ENTRYPOINT }}
        run: node scripts/ci/gate.mjs

      - name: Upload risk-policy-gate artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: risk-policy-gate-${{ needs.preflight.outputs.tested_sha }}
          path: .artifacts/risk-policy-gate/${{ needs.preflight.outputs.tested_sha }}/result.json
          if-no-files-found: warn
