# Applications

## Purpose

The `apps/` directory contains the runtime services for Compass:

- API service (`apps/api`) for HTTP system endpoints and contract-backed responses.
- Web service (`apps/web`) for the React Router browser UI.
- Worker service (`apps/worker`) for asynchronous Service Bus processing.
- Dynamic Sessions runtime (`apps/codex-session-runtime`) for Azure session-pool containers.
- Desktop app (`apps/desktop`) for Electron-based macOS/Windows distribution.

## Service Topology

1. Web serves UI on `WEB_PORT` and calls the API using `VITE_API_BASE_URL`.
2. API serves `/health`, `/openapi.json`, and `/v1/ping` on `API_PORT`.
3. Worker consumes Service Bus events and settles messages (complete, abandon, dead-letter).
4. Dynamic Sessions runtime serves a minimal health endpoint for session containers.
5. Desktop hosts the web UI inside Electron and exposes preload-only desktop APIs.

## Directory Map

| Path                          | Responsibility                                                                           |
| ----------------------------- | ---------------------------------------------------------------------------------------- |
| `apps/api/`                   | Express API, env parsing, health/OpenAPI/ping routes, and integration tests.             |
| `apps/web/`                   | React Router app, home route health checks, and client runtime build output.             |
| `apps/codex-session-runtime/` | Minimal session-container runtime image used by Dynamic Sessions pools.                  |
| `apps/worker/`                | Service Bus consumer, message schema validation, and retry/dead-letter settlement logic. |
| `apps/desktop/`               | Electron main/preload runtime, installer packaging, desktop release flow.                |

## Local Ports and Env Files

| Service         | Local Port                                          | Env Example File              |
| --------------- | --------------------------------------------------- | ----------------------------- |
| API             | `API_PORT` (auto-generated per worktree by default) | `apps/api/.env.example`       |
| Web             | `WEB_PORT` (auto-generated per worktree by default) | `apps/web/.env.example`       |
| Session runtime | `PORT` (container env, defaults to `8080`)          | N/A (container-only runtime)  |
| Worker          | N/A (queue consumer)                                | `apps/worker/.env.example`    |
| Desktop         | N/A (native shell)                                  | N/A (release workflow inputs) |

`pnpm dev` bootstraps missing local `.env` files for API/Web plus `db/postgres/.env` and applies this precedence for generated values:

1. explicit shell env var
2. existing `.env` value
3. generated per-worktree default

Worker env is not auto-generated by that bootstrap step. Session runtime is container-only and not part of `pnpm dev`.

## Default Local Dev Commands

- `pnpm dev` starts API and web (local core).
- `pnpm dev:all` starts all services, including worker.
- `pnpm dev:worker` starts only the worker and requires cloud credentials.

## Where To Change What

- API behavior/config: [`apps/api/README.md`](./api/README.md)
- Web behavior/config: [`apps/web/README.md`](./web/README.md)
- Session runtime behavior/config: [`apps/codex-session-runtime/README.md`](./codex-session-runtime/README.md)
- Worker queue processing: [`apps/worker/README.md`](./worker/README.md)
- Desktop runtime/release: [`apps/desktop/README.md`](./desktop/README.md)
